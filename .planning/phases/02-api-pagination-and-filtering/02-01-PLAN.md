---
phase: 02-api-pagination-and-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - upstream/settings/base.py
  - upstream/api/filters.py
  - upstream/api/views.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Users can filter ClaimRecord list by payer (icontains), outcome (exact), and date ranges"
    - "Users can filter DriftEvent list by payer, drift_type, and severity range"
    - "Users can search ClaimRecord by claim_number and payer text"
    - "Users can search DriftEvent by payer and cpt_code text"
    - "Filter controls appear in DRF browsable API"
  artifacts:
    - path: "upstream/api/filters.py"
      provides: "FilterSet classes for ClaimRecord and DriftEvent"
      exports: ["ClaimRecordFilter", "DriftEventFilter"]
    - path: "upstream/api/views.py"
      provides: "ViewSets with filter_backends, search_fields, filterset_class"
      contains: "DjangoFilterBackend"
    - path: "upstream/settings/base.py"
      provides: "django_filters in INSTALLED_APPS"
      contains: "django_filters"
  key_links:
    - from: "upstream/api/views.py"
      to: "upstream/api/filters.py"
      via: "filterset_class import"
      pattern: "from .filters import"
    - from: "upstream/settings/base.py"
      to: "django_filters"
      via: "INSTALLED_APPS"
      pattern: "django_filters"
---

<objective>
Add DjangoFilterBackend and SearchFilter to API ViewSets for declarative filtering

Purpose: Replace hand-rolled filter logic with django-filter's battle-tested FilterSet classes. This provides type validation, browsable API controls, and automatic OpenAPI documentation for all filter parameters.

Output: FilterSet classes for ClaimRecord and DriftEvent, ViewSets updated with filter_backends/search_fields, django-filter installed and configured.
</objective>

<execution_context>
@/home/codespace/.claude/get-shit-done/workflows/execute-plan.md
@/home/codespace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-api-pagination-and-filtering/02-RESEARCH.md

Key files:
@upstream/api/views.py - ViewSets with current hand-rolled filters
@upstream/settings/base.py - INSTALLED_APPS and REST_FRAMEWORK config
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install django-filter and configure settings</name>
  <files>
    requirements.txt
    upstream/settings/base.py
  </files>
  <action>
1. Add django-filter to requirements.txt:
   ```
   django-filter~=25.1
   ```
   Note: Use 25.1 (not 25.2) as that's the latest stable release compatible with Django 5.2.

2. Run pip install to install the package:
   ```bash
   pip install django-filter~=25.1
   ```

3. Add 'django_filters' to INSTALLED_APPS in upstream/settings/base.py:
   - Add after 'drf_spectacular' in the Third-party - API section
   - The app name is 'django_filters' (with underscore), not 'django-filter'

4. Add DEFAULT_FILTER_BACKENDS to REST_FRAMEWORK settings:
   ```python
   "DEFAULT_FILTER_BACKENDS": [
       "django_filters.rest_framework.DjangoFilterBackend",
       "rest_framework.filters.SearchFilter",
       "rest_framework.filters.OrderingFilter",
   ],
   ```
   This sets global defaults that ViewSets inherit automatically.
  </action>
  <verify>
    Run: python -c "import django_filters; print(django_filters.__version__)"
    Run: python manage.py check
  </verify>
  <done>
    django-filter installed, 'django_filters' in INSTALLED_APPS, DEFAULT_FILTER_BACKENDS configured
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FilterSet classes for complex filtering</name>
  <files>
    upstream/api/filters.py
  </files>
  <action>
Create upstream/api/filters.py with FilterSet classes:

```python
"""
API Filter classes for Upstream ViewSets.

Uses django-filter for declarative, validated filtering with automatic
OpenAPI documentation via drf-spectacular.
"""

from django_filters import rest_framework as filters

from upstream.models import ClaimRecord, DriftEvent


class ClaimRecordFilter(filters.FilterSet):
    """
    FilterSet for ClaimRecord with date range and text filtering.

    Replaces hand-rolled filter logic in ClaimRecordViewSet.get_queryset().
    """
    # Text filters with icontains for partial matching
    payer = filters.CharFilter(field_name='payer', lookup_expr='icontains')

    # Exact match for outcome (PAID, DENIED, OTHER)
    outcome = filters.CharFilter(field_name='outcome', lookup_expr='iexact')

    # Date range filters for decided_date
    start_date = filters.DateFilter(field_name='decided_date', lookup_expr='gte')
    end_date = filters.DateFilter(field_name='decided_date', lookup_expr='lte')

    # Additional useful filters
    claim_number = filters.CharFilter(field_name='claim_number', lookup_expr='icontains')
    cpt_code = filters.CharFilter(field_name='cpt_code', lookup_expr='exact')

    class Meta:
        model = ClaimRecord
        fields = ['payer', 'outcome', 'start_date', 'end_date', 'claim_number', 'cpt_code']


class DriftEventFilter(filters.FilterSet):
    """
    FilterSet for DriftEvent with severity range and type filtering.

    Replaces hand-rolled filter logic in DriftEventViewSet.get_queryset().
    """
    # Text filter for payer with partial matching
    payer = filters.CharFilter(field_name='payer', lookup_expr='icontains')

    # Exact match for drift_type (case-insensitive)
    drift_type = filters.CharFilter(field_name='drift_type', lookup_expr='iexact')

    # Severity range filters
    min_severity = filters.NumberFilter(field_name='severity', lookup_expr='gte')
    max_severity = filters.NumberFilter(field_name='severity', lookup_expr='lte')

    # Date range filters
    created_after = filters.DateTimeFilter(field_name='created_at', lookup_expr='gte')
    created_before = filters.DateTimeFilter(field_name='created_at', lookup_expr='lte')

    # Report run filter for getting events from specific run
    report_run = filters.NumberFilter(field_name='report_run_id', lookup_expr='exact')

    class Meta:
        model = DriftEvent
        fields = ['payer', 'drift_type', 'min_severity', 'max_severity',
                  'created_after', 'created_before', 'report_run']
```

Key design decisions:
- Use icontains for text fields (payer) to support partial matching
- Use iexact for enum-like fields (outcome, drift_type) for case-insensitive exact match
- Date filters use gte/lte for range queries
- Severity filters use NumberFilter for proper type validation
- Do NOT expose customer_id or other tenant fields (security)
  </action>
  <verify>
    Run: python -c "from upstream.api.filters import ClaimRecordFilter, DriftEventFilter; print('Filters imported successfully')"
  </verify>
  <done>
    FilterSet classes created with date range, severity range, and text filtering
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ViewSets with filter backends and search fields</name>
  <files>
    upstream/api/views.py
  </files>
  <action>
Update upstream/api/views.py to use django-filter:

1. Add import at top of file:
   ```python
   from django_filters.rest_framework import DjangoFilterBackend
   from .filters import ClaimRecordFilter, DriftEventFilter
   ```

2. Update ClaimRecordViewSet:
   - Add to class attributes:
     ```python
     filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
     filterset_class = ClaimRecordFilter
     search_fields = ['claim_number', 'payer', 'cpt_code']  # icontains by default
     ```
   - REMOVE the hand-rolled filter logic in get_queryset() that handles:
     - payer query param
     - outcome query param
     - start_date/end_date query params
   - Keep ONLY the select_related optimization and CustomerFilterMixin logic

3. Update DriftEventViewSet:
   - Add to class attributes:
     ```python
     filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
     filterset_class = DriftEventFilter
     search_fields = ['payer', 'cpt_code']
     ordering_fields = ['created_at', 'severity', 'payer']
     ```
   - REMOVE the hand-rolled filter logic in get_queryset() that handles:
     - min_severity query param
     - payer query param
     - drift_type query param
   - Keep ONLY the CustomerFilterMixin logic

4. Update UploadViewSet:
   - Change filter_backends to include all three:
     ```python
     filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
     ```
   - Add search_fields:
     ```python
     search_fields = ['filename', 'status']
     ```
   - Add filterset_fields for simple filtering:
     ```python
     filterset_fields = ['status']
     ```

5. Update AlertEventViewSet:
   - Add filter_backends:
     ```python
     filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
     ```
   - Add filterset_fields:
     ```python
     filterset_fields = ['status', 'delivery_method']
     ```
   - Add search_fields:
     ```python
     search_fields = ['drift_event__payer']
     ```
   - Add ordering_fields:
     ```python
     ordering_fields = ['triggered_at', 'status']
     ```

Important: The DEFAULT_FILTER_BACKENDS in settings provides defaults, but explicit filter_backends on ViewSets is clearer and allows customization per ViewSet.
  </action>
  <verify>
    Run: python manage.py check
    Run: python -c "from upstream.api.views import ClaimRecordViewSet; print(ClaimRecordViewSet.filterset_class)"
    Test API: Start server and visit /api/v1/claims/ - filter controls should appear in browsable API
  </verify>
  <done>
    ViewSets use DjangoFilterBackend with FilterSet classes, hand-rolled filter logic removed, search_fields configured
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Filter functionality:**
   ```bash
   # Test ClaimRecord filters
   curl -X GET "http://localhost:8000/api/v1/claims/?payer=aetna"
   curl -X GET "http://localhost:8000/api/v1/claims/?outcome=denied"
   curl -X GET "http://localhost:8000/api/v1/claims/?start_date=2024-01-01&end_date=2024-12-31"

   # Test DriftEvent filters
   curl -X GET "http://localhost:8000/api/v1/drift-events/?min_severity=0.5"
   curl -X GET "http://localhost:8000/api/v1/drift-events/?drift_type=denial_rate"
   ```

2. **Search functionality:**
   ```bash
   # Test search (uses icontains across search_fields)
   curl -X GET "http://localhost:8000/api/v1/claims/?search=CLM123"
   curl -X GET "http://localhost:8000/api/v1/drift-events/?search=aetna"
   ```

3. **Browsable API:**
   - Visit /api/v1/claims/ in browser
   - Filter controls should appear
   - Search box should be visible

4. **Django check passes:**
   ```bash
   python manage.py check
   ```
</verification>

<success_criteria>
- django-filter~=25.1 installed and in requirements.txt
- 'django_filters' in INSTALLED_APPS
- DEFAULT_FILTER_BACKENDS configured in REST_FRAMEWORK settings
- ClaimRecordFilter and DriftEventFilter classes created
- ViewSets updated with filterset_class and search_fields
- Hand-rolled filter logic removed from get_queryset methods
- Filter controls visible in DRF browsable API
- All existing tests pass (filters maintain backward compatibility)
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-pagination-and-filtering/02-01-SUMMARY.md`
</output>
