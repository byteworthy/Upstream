---
phase: 07-frontend-unit-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/__tests__/Settings.test.tsx
autonomous: true

must_haves:
  truths:
    - "SpecialtyModulesCard displays all specialty modules with correct labels"
    - "Toggle switch is disabled for primary specialty"
    - "Toggle switch enables specialty when clicked (calls enableSpecialty)"
    - "Toggle switch disables specialty when clicked (calls disableSpecialty)"
    - "Loading state shows spinner while customer data loads"
  artifacts:
    - path: "frontend/src/pages/__tests__/Settings.test.tsx"
      provides: "Settings page tests focusing on SpecialtyModulesCard"
      min_lines: 120
  key_links:
    - from: "Settings.test.tsx"
      to: "CustomerContext"
      via: "fetch mock + enableSpecialty/disableSpecialty calls"
      pattern: "globalThis.*fetch.*vi\\.fn"
---

<objective>
Create unit tests for Settings page focusing on the SpecialtyModulesCard toggle functionality.

Purpose: Validate that users can enable/disable specialty modules through the Settings page, with proper handling of the primary specialty restriction.

Output: Test file covering SpecialtyModulesCard component behavior including toggle interactions.
</objective>

<execution_context>
@/home/codespace/.claude/get-shit-done/workflows/execute-plan.md
@/home/codespace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-frontend-unit-tests/07-RESEARCH.md

# Source file to test
@frontend/src/pages/Settings.tsx

# Pattern reference
@frontend/src/contexts/__tests__/CustomerContext.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Settings SpecialtyModulesCard tests</name>
  <files>frontend/src/pages/__tests__/Settings.test.tsx</files>
  <action>
Create comprehensive tests for the SpecialtyModulesCard component within Settings page.

Test cases to implement:
1. Shows loading spinner while customer data loads
2. Displays all 5 specialty modules (Dialysis, ABA Therapy, Imaging, Home Health, PT/OT)
3. Shows "Primary" badge next to primary specialty
4. Toggle switch is disabled for primary specialty (cannot be turned off)
5. Toggle switch is enabled (checked) for enabled specialties
6. Toggle switch is disabled (unchecked) for non-enabled specialties
7. Clicking toggle calls enableSpecialty when turning on
8. Clicking toggle calls disableSpecialty when turning off
9. Shows spinner on individual toggle while request in progress
10. Handles error gracefully (toast shown via context, rollback occurs)

Use userEvent for clicking toggles. Mock fetch for customer data and enable/disable API calls.

Mock customer data with DIALYSIS as primary and enabled:
```typescript
const mockCustomer = {
  id: 1,
  name: 'Test Customer',
  specialty_type: 'DIALYSIS',
  specialty_modules: [
    { id: 1, specialty: 'DIALYSIS', enabled: true, enabled_at: '2024-01-01', is_primary: true },
  ],
  enabled_specialties: ['DIALYSIS'],
};
```

Use `screen.getByRole('switch', { name: /toggle dialysis/i })` to find switches by aria-label.

Important: The SpecialtyModulesCard is inside Settings, so render Settings component and test the card within it.
  </action>
  <verify>Run `cd /workspaces/codespaces-django/frontend && npm test -- --run src/pages/__tests__/Settings.test.tsx` and confirm all tests pass</verify>
  <done>10 test cases pass covering loading state, specialty display, primary badge, toggle states, enable/disable calls, and error handling</done>
</task>

<task type="auto">
  <name>Task 2: Add Settings automation settings basic tests</name>
  <files>frontend/src/pages/__tests__/Settings.test.tsx</files>
  <action>
Extend the Settings test file with basic tests for the automation settings section (not specialty-related but ensures overall page renders correctly).

Additional test cases:
1. Renders Settings page header with "Automation Settings" title
2. Shows automation stage selector with default "Supervised Mode"
3. Shows confidence threshold sliders
4. Shows action toggles section
5. Save button appears after making changes
6. Discard button appears after making changes

These are simpler smoke tests to ensure the Settings page overall renders without errors.
  </action>
  <verify>Run `cd /workspaces/codespaces-django/frontend && npm test -- --run src/pages/__tests__/Settings.test.tsx` and confirm all tests pass</verify>
  <done>16 total test cases in Settings.test.tsx covering SpecialtyModulesCard (10) and general settings UI (6)</done>
</task>

</tasks>

<verification>
```bash
cd /workspaces/codespaces-django/frontend
npm test -- --run src/pages/__tests__/Settings.test.tsx
```

All 16 tests should pass. Toggle interactions should properly simulate user clicks.
</verification>

<success_criteria>
- Settings.test.tsx has 16+ passing test cases
- SpecialtyModulesCard toggle functionality fully tested (enable/disable flows)
- Primary specialty toggle is verified as disabled
- User interactions tested with userEvent (not fireEvent)
- Error handling rollback tested
</success_criteria>

<output>
After completion, create `.planning/phases/07-frontend-unit-tests/07-02-SUMMARY.md`
</output>
