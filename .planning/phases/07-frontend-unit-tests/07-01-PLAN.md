---
phase: 07-frontend-unit-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/guards/__tests__/SpecialtyRoute.test.tsx
  - frontend/src/components/layout/__tests__/Sidebar.test.tsx
autonomous: true

must_haves:
  truths:
    - "SpecialtyRoute renders children when customer has required specialty enabled"
    - "SpecialtyRoute redirects to fallback when specialty not enabled"
    - "SpecialtyRoute shows loading state while customer data loads"
    - "Sidebar shows specialty nav items only for enabled specialties"
    - "Sidebar hides specialty nav items for disabled specialties"
  artifacts:
    - path: "frontend/src/components/guards/__tests__/SpecialtyRoute.test.tsx"
      provides: "SpecialtyRoute component tests"
      min_lines: 80
    - path: "frontend/src/components/layout/__tests__/Sidebar.test.tsx"
      provides: "Sidebar component tests"
      min_lines: 100
  key_links:
    - from: "SpecialtyRoute.test.tsx"
      to: "CustomerContext"
      via: "fetch mock"
      pattern: "globalThis.*fetch.*vi\\.fn"
    - from: "Sidebar.test.tsx"
      to: "CustomerContext"
      via: "fetch mock"
      pattern: "globalThis.*fetch.*vi\\.fn"
---

<objective>
Create unit tests for SpecialtyRoute guard component and Sidebar dynamic navigation.

Purpose: Validate that route guards correctly redirect unauthorized specialty access and that sidebar navigation dynamically updates based on enabled specialties.

Output: Two test files covering SpecialtyRoute redirect logic and Sidebar navigation rendering.
</objective>

<execution_context>
@/home/codespace/.claude/get-shit-done/workflows/execute-plan.md
@/home/codespace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-frontend-unit-tests/07-RESEARCH.md

# Source files to test
@frontend/src/components/guards/SpecialtyRoute.tsx
@frontend/src/components/layout/Sidebar.tsx

# Pattern reference
@frontend/src/contexts/__tests__/CustomerContext.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpecialtyRoute unit tests</name>
  <files>frontend/src/components/guards/__tests__/SpecialtyRoute.test.tsx</files>
  <action>
Create comprehensive tests for the SpecialtyRoute component using patterns from CustomerContext.test.tsx.

Test cases to implement:
1. Shows loading state while customer data loads
2. Renders children when customer has required specialty enabled
3. Redirects to fallback path (/dashboard) when specialty not enabled
4. Redirects to custom fallback path when specified
5. Redirects to /login when no customer (not authenticated)
6. withSpecialtyGuard HOC wraps component correctly

Use MemoryRouter with initialEntries for testing redirect behavior. Set up fetch mock BEFORE render to return mock customer data. Use waitFor to handle async customer loading.

Mock customer data pattern:
```typescript
const mockCustomerWithDialysis = {
  id: 1,
  name: 'Test Customer',
  specialty_type: 'DIALYSIS',
  specialty_modules: [{ id: 1, specialty: 'DIALYSIS', enabled: true, enabled_at: '2024-01-01', is_primary: true }],
  enabled_specialties: ['DIALYSIS'],
};
```

Test redirect by checking for fallback content (e.g., "Dashboard" text) and absence of protected content.
  </action>
  <verify>Run `cd /workspaces/codespaces-django/frontend && npm test -- --run src/components/guards/__tests__/SpecialtyRoute.test.tsx` and confirm all tests pass</verify>
  <done>6 test cases pass covering loading state, authorized access, unauthorized redirect, custom fallback, login redirect, and HOC functionality</done>
</task>

<task type="auto">
  <name>Task 2: Create Sidebar unit tests</name>
  <files>frontend/src/components/layout/__tests__/Sidebar.test.tsx</files>
  <action>
Create comprehensive tests for the Sidebar component's dynamic navigation based on enabled specialties.

Test cases to implement:
1. Shows core nav items (Dashboard, Claim Scores, Work Queue, Alerts, Execution Log, Settings) always
2. Shows specialty nav items only for enabled specialties (e.g., DIALYSIS shows "Dialysis" link)
3. Hides specialty nav items for disabled specialties (e.g., no ABA links when ABA not enabled)
4. Shows multiple specialty nav items when multiple specialties enabled
5. Deduplicates nav items when multiple specialties share same route (e.g., Authorizations)
6. Shows customer name in header
7. Shows primary specialty label in header
8. Shows loading skeleton when customer data loading
9. Shows "Active modules" footer indicator when >1 specialty enabled

Use MemoryRouter wrapper for NavLink functionality. Set isOpen={true} for visibility testing.

Mock fetch to return customer data with various specialty configurations to test each scenario.
  </action>
  <verify>Run `cd /workspaces/codespaces-django/frontend && npm test -- --run src/components/layout/__tests__/Sidebar.test.tsx` and confirm all tests pass</verify>
  <done>9 test cases pass covering core nav, specialty nav visibility, deduplication, header display, loading state, and active modules indicator</done>
</task>

</tasks>

<verification>
```bash
cd /workspaces/codespaces-django/frontend
npm test -- --run src/components/guards/__tests__/SpecialtyRoute.test.tsx src/components/layout/__tests__/Sidebar.test.tsx
```

All tests should pass without errors. No console warnings about missing Router context.
</verification>

<success_criteria>
- SpecialtyRoute.test.tsx has 6+ passing test cases
- Sidebar.test.tsx has 9+ passing test cases
- Both test files use consistent patterns from CustomerContext.test.tsx
- Tests validate user-visible behavior, not implementation details
- No flaky tests (all use proper async handling with waitFor)
</success_criteria>

<output>
After completion, create `.planning/phases/07-frontend-unit-tests/07-01-SUMMARY.md`
</output>
