{
  "branchName": "phase-06-database-indexes",
  "context": {
    "phase": "06",
    "phaseName": "Database Indexes",
    "phaseGoal": "Add missing database indexes to improve query performance for webhooks, alerts, and user lookups",
    "requirements": ["PERF-02", "DB-03"],
    "dependsOn": "Phase 5 (Performance Testing & Rollback Fix)",
    "successCriteria": [
      "UserProfile has indexes on user and customer foreign keys for faster lookups",
      "AlertRule has composite index on (customer, enabled) for alert evaluation queries",
      "NotificationChannel has composite index on (customer, enabled, channel_type) for channel lookups",
      "WebhookDelivery has composite index on (status, next_attempt_at) for retry queries",
      "IntegrationLog has composite index on (connection, -start_time) for connection history",
      "Migration creates all 6 indexes without errors"
    ],
    "qualityGates": [
      "python manage.py check",
      "python manage.py makemigrations --check --dry-run",
      "python manage.py test upstream.tests_models -v 2"
    ]
  },
  "userStories": [
    {
      "id": 1,
      "title": "Add db_index to UserProfile foreign keys (user, customer)",
      "description": "Add db_index=True to UserProfile.user and UserProfile.customer fields. These fields are used in WHERE clauses for user lookups (WHERE user_id=X) and customer filtering (WHERE customer_id=X). Without indexes, these become full table scans as UserProfile grows. Update upstream/models.py or the specific model file where UserProfile is defined.",
      "acceptanceCriteria": [
        "UserProfile.user has db_index=True",
        "UserProfile.customer has db_index=True",
        "Migration generated with AddIndex operations",
        "Django check passes",
        "Indexes visible in database schema (sqlite_master or pg_indexes)"
      ],
      "files": [
        "upstream/models.py",
        "upstream/migrations/00XX_add_userprofile_indexes.py"
      ],
      "passes": false
    },
    {
      "id": 2,
      "title": "Add composite index to AlertRule for (customer, enabled) lookups",
      "description": "Create Meta.indexes with Index(fields=['customer', 'enabled'], name='idx_alertrule_customer_enabled') in AlertRule model. Alert evaluation queries filter by customer AND enabled status simultaneously: WHERE customer=X AND enabled=true. Composite index is more efficient than separate indexes. Located in upstream/alerts/models.py.",
      "acceptanceCriteria": [
        "AlertRule.Meta.indexes includes composite (customer, enabled) index",
        "Migration creates index with correct field order",
        "Index name follows Django naming convention",
        "Query plan shows index usage for customer+enabled filters",
        "Tests pass"
      ],
      "files": [
        "upstream/alerts/models.py",
        "upstream/migrations/00XX_add_alertrule_composite_index.py"
      ],
      "passes": false
    },
    {
      "id": 3,
      "title": "Add composite indexes to NotificationChannel and WebhookDelivery",
      "description": "Add two composite indexes: (1) NotificationChannel: Index(fields=['customer', 'enabled', 'channel_type'], name='idx_notificationchannel_lookup') for channel selection queries. (2) WebhookDelivery: Index(fields=['status', 'next_attempt_at'], name='idx_webhookdelivery_retry') for retry job queries WHERE status='retrying' AND next_attempt_at <= NOW(). These are in upstream/alerts/models.py and upstream/integrations/models.py.",
      "acceptanceCriteria": [
        "NotificationChannel has 3-field composite index",
        "WebhookDelivery has 2-field composite index on retry columns",
        "Single migration creates both indexes",
        "Index names follow Django conventions",
        "Webhook retry queries use new index (verify with EXPLAIN)",
        "All tests pass"
      ],
      "files": [
        "upstream/alerts/models.py",
        "upstream/integrations/models.py",
        "upstream/migrations/00XX_add_notification_webhook_indexes.py"
      ],
      "passes": false
    },
    {
      "id": 4,
      "title": "Add composite index to IntegrationLog for connection history queries",
      "description": "Create Meta.indexes with Index(fields=['connection', '-start_time'], name='idx_integrationlog_history') in IntegrationLog model. Connection monitoring queries need: WHERE connection=X ORDER BY start_time DESC. Descending index on start_time (-start_time) optimizes ORDER BY DESC queries. Located in upstream/integrations/models.py.",
      "acceptanceCriteria": [
        "IntegrationLog has composite index with DESC ordering on start_time",
        "Index uses Django's descending field syntax (-start_time)",
        "Migration creates index correctly",
        "Connection history queries use index (verify with EXPLAIN)",
        "Tests verify index exists in schema",
        "All quality gates pass"
      ],
      "files": [
        "upstream/integrations/models.py",
        "upstream/migrations/00XX_add_integrationlog_index.py"
      ],
      "passes": false
    }
  ]
}
