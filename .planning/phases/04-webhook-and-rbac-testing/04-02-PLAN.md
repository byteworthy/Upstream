---
phase: 04-webhook-and-rbac-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - upstream/tests_rbac.py
autonomous: true

must_haves:
  truths:
    - "Superuser can list and retrieve all customers' data across all ViewSets"
    - "Customer admin (Customer A) cannot see Customer B data - returns 404"
    - "Regular user has read-only access - cannot POST/PUT/DELETE"
    - "List endpoints automatically filter by authenticated user's customer"
    - "Direct ID access to other customer's object returns 404 (not 403)"
  artifacts:
    - path: "upstream/tests_rbac.py"
      provides: "Comprehensive RBAC API endpoint tests"
      min_lines: 350
  key_links:
    - from: "upstream/tests_rbac.py"
      to: "upstream/api/views.py"
      via: "APIClient requests to ViewSet endpoints"
      pattern: "self.client.(get|post|put|delete)"
---

<objective>
Extend RBAC tests to validate customer isolation across all API endpoints, ensuring superuser access, customer admin isolation, and regular user read-only restrictions.

Purpose: Prove that users from Customer A cannot access Customer B's data even via direct API calls, preventing cross-tenant data leakage.

Output: Extended `upstream/tests_rbac.py` with 15+ test cases covering all ViewSets and role combinations.
</objective>

<execution_context>
@/home/codespace/.claude/get-shit-done/workflows/execute-plan.md
@/home/codespace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference existing patterns
@upstream/tests_rbac.py (existing RBAC unit tests)
@upstream/tests_tenant_isolation.py (tenant isolation patterns)
@upstream/tests_api.py (API test base class patterns)
@upstream/api/views.py (ViewSets to test)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RBACCustomerIsolationTests class with multi-customer setup</name>
  <files>upstream/tests_rbac.py</files>
  <action>
    Add new test class RBACCustomerIsolationTests to upstream/tests_rbac.py:

    1. Use APITestCase from rest_framework.test (like tests_api.py)

    2. setUp creates:
       - 2 customers: Customer A and Customer B
       - superuser (Django superuser, no UserProfile needed)
       - customer_a_admin (UserProfile with customer=A, role='admin')
       - customer_a_viewer (UserProfile with customer=A, role='viewer')
       - customer_b_admin (UserProfile with customer=B, role='admin')

    3. Create test data for BOTH customers:
       - Upload (1 per customer)
       - ClaimRecord (2 per customer, linked to upload)
       - ReportRun (1 per customer)
       - DriftEvent (2 per customer, linked to report_run)
       - PayerMapping (1 per customer)

    4. Helper methods:
       - authenticate_as_superuser()
       - authenticate_as_customer_a_admin()
       - authenticate_as_customer_a_viewer()
       - authenticate_as_customer_b_admin()
       - get_auth_headers(user) - returns JWT Bearer token header

    Use all_objects.create() to bypass tenant filtering during setup.
    Reference tests_api.py for JWT authentication pattern.
  </action>
  <verify>
    ```bash
    python -c "from upstream.tests_rbac import RBACCustomerIsolationTests; print('Class imports')"
    ```
  </verify>
  <done>
    - RBACCustomerIsolationTests class with setUp creating 2 customers, 4 users, test data
    - Helper methods for authenticating as different users
    - All setup data created successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement superuser access and customer isolation tests</name>
  <files>upstream/tests_rbac.py</files>
  <action>
    Add test methods to RBACCustomerIsolationTests:

    **Superuser Tests (can see all):**
    1. test_superuser_can_list_all_uploads:
       - Authenticate as superuser
       - GET /api/uploads/ - should return 2 uploads (both customers)

    2. test_superuser_can_retrieve_any_customer_upload:
       - GET /api/uploads/{customer_b_upload_id}/ as superuser - should return 200

    **Customer Isolation Tests (admin cannot see other customer):**
    3. test_customer_a_admin_list_only_sees_own_uploads:
       - Authenticate as customer_a_admin
       - GET /api/uploads/ - should return 1 upload (only Customer A)

    4. test_customer_a_admin_cannot_retrieve_customer_b_upload:
       - GET /api/uploads/{customer_b_upload_id}/ as customer_a_admin
       - Should return 404 (not 403 - avoid leaking existence)

    5. test_customer_a_admin_list_only_sees_own_drift_events:
       - GET /api/drift-events/ as customer_a_admin - only 2 events (Customer A)

    6. test_customer_a_admin_cannot_retrieve_customer_b_drift_event:
       - GET /api/drift-events/{customer_b_drift_id}/ - returns 404

    7. test_customer_a_admin_list_only_sees_own_claim_records:
       - GET /api/claim-records/ as customer_a_admin - only 2 claims (Customer A)

    8. test_customer_b_admin_cannot_see_customer_a_data:
       - Authenticate as customer_b_admin
       - GET /api/uploads/{customer_a_upload_id}/ - returns 404

    API endpoints to test (from urls.py):
    - /api/uploads/
    - /api/claim-records/
    - /api/drift-events/
    - /api/payer-mappings/
    - /api/report-runs/
  </action>
  <verify>
    ```bash
    python manage.py test upstream.tests_rbac.RBACCustomerIsolationTests -v 2
    ```
    All 8 tests pass.
  </verify>
  <done>
    - 8 customer isolation tests passing
    - Superuser can access all data
    - Customer admin can only access own customer's data
    - Cross-customer access returns 404 (not 403)
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement viewer read-only and write permission tests</name>
  <files>upstream/tests_rbac.py</files>
  <action>
    Add more test methods to RBACCustomerIsolationTests:

    **Viewer Read-Only Tests:**
    9. test_viewer_can_list_own_customer_uploads:
       - Authenticate as customer_a_viewer
       - GET /api/uploads/ - returns 200 with Customer A's upload

    10. test_viewer_cannot_create_upload:
        - POST /api/uploads/ as customer_a_viewer
        - Should return 403 Forbidden (viewers are read-only)

    11. test_viewer_cannot_delete_upload:
        - DELETE /api/uploads/{customer_a_upload_id}/ as customer_a_viewer
        - Should return 403 Forbidden

    12. test_viewer_cannot_create_payer_mapping:
        - POST /api/payer-mappings/ as customer_a_viewer
        - Should return 403 Forbidden

    **Admin Write Tests (should succeed):**
    13. test_admin_can_create_payer_mapping:
        - POST /api/payer-mappings/ as customer_a_admin
        - Should return 201 Created (or 200/400 for validation)

    14. test_admin_can_update_own_payer_mapping:
        - PUT /api/payer-mappings/{id}/ as customer_a_admin
        - Should return 200 OK

    **Cross-Customer Write Protection:**
    15. test_admin_cannot_update_other_customer_payer_mapping:
        - PUT /api/payer-mappings/{customer_b_mapping_id}/ as customer_a_admin
        - Should return 404 (object not found in customer scope)

    16. test_unauthenticated_user_denied:
        - GET /api/uploads/ without auth
        - Should return 401 Unauthorized
  </action>
  <verify>
    ```bash
    python manage.py test upstream.tests_rbac.RBACCustomerIsolationTests -v 2
    ```
    All 16 tests pass.
  </verify>
  <done>
    - 16 total RBAC isolation tests passing
    - Viewer read-only enforced (cannot POST/PUT/DELETE)
    - Admin write access works for own customer
    - Cross-customer writes blocked with 404
    - Unauthenticated access blocked with 401
  </done>
</task>

</tasks>

<verification>
```bash
# Run all RBAC tests
python manage.py test upstream.tests_rbac -v 2

# Verify test count (existing + new should be 30+)
python manage.py test upstream.tests_rbac --verbosity=0 2>&1 | grep -E "^(OK|Ran)"

# Run just the new isolation tests
python manage.py test upstream.tests_rbac.RBACCustomerIsolationTests -v 2
```
</verification>

<success_criteria>
- [ ] RBACCustomerIsolationTests class with 2 customers, 4 users, test data
- [ ] 16+ new RBAC tests pass
- [ ] Superuser can access all customers' data
- [ ] Customer admin isolated to own customer (404 on cross-customer access)
- [ ] Viewer has read-only access (403 on write operations)
- [ ] All ViewSets tested: uploads, claim-records, drift-events, payer-mappings
- [ ] Test suite fails if customer isolation breaks
</success_criteria>

<output>
After completion, create `.planning/phases/04-webhook-and-rbac-testing/04-02-SUMMARY.md`
</output>
