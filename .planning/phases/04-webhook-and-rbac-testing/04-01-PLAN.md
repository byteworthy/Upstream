---
phase: 04-webhook-and-rbac-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - upstream/tests_webhooks.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Webhook tests validate POST delivery to endpoint on drift event creation"
    - "Webhook tests verify HMAC-SHA256 signature in X-Signature header"
    - "Webhook tests confirm 200 response marks delivery as success"
    - "Webhook tests verify retry logic on 500 error with exponential backoff"
    - "Webhook tests confirm max 3 retries then terminal failure"
    - "Webhook tests verify idempotency key prevents duplicate processing"
  artifacts:
    - path: "upstream/tests_webhooks.py"
      provides: "Comprehensive webhook integration tests"
      min_lines: 200
  key_links:
    - from: "upstream/tests_webhooks.py"
      to: "upstream/integrations/services.py"
      via: "imports deliver_webhook, generate_signature"
      pattern: "from upstream.integrations.services import"
---

<objective>
Create comprehensive webhook integration tests that validate delivery, retry logic, signature validation, and idempotency using mock HTTP responses.

Purpose: Ensure webhook delivery system works correctly and fails appropriately, providing confidence in the external notification system.

Output: `upstream/tests_webhooks.py` with 8+ test cases covering all webhook behaviors.
</objective>

<execution_context>
@/home/codespace/.claude/get-shit-done/workflows/execute-plan.md
@/home/codespace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference existing patterns
@upstream/tests_delivery.py (existing webhook tests with @patch)
@upstream/integrations/services.py (webhook delivery implementation)
@upstream/integrations/models.py (WebhookEndpoint, WebhookDelivery models)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WebhookTestCase base class with responses library</name>
  <files>upstream/tests_webhooks.py, requirements.txt</files>
  <action>
    Create new test file upstream/tests_webhooks.py with:

    1. Add `responses~=0.25.0` to requirements.txt (mock HTTP library, already used in Django ecosystem)

    2. Create WebhookTestCase base class with:
       - setUp: Create customer, webhook endpoint with test URL (https://webhook.test/receive), secret key
       - Helper method to capture webhook payloads from responses mock
       - Helper method to validate HMAC signature using generate_signature from integrations.services
       - Helper method to create drift events that trigger webhook delivery

    3. Use @responses.activate decorator pattern (similar to unittest.mock but for HTTP):
       ```python
       import responses

       @responses.activate
       def test_webhook_delivery_success(self):
           responses.add(responses.POST, 'https://webhook.test/receive', status=200)
           # test code
       ```

    Reference existing test patterns from tests_delivery.py for model setup.
  </action>
  <verify>
    ```bash
    pip install responses~=0.25.0
    python -c "import responses; print('responses installed')"
    python -c "from upstream.tests_webhooks import WebhookTestCase; print('WebhookTestCase imports')"
    ```
  </verify>
  <done>
    - WebhookTestCase base class exists with setUp, helper methods
    - responses library added to requirements.txt
    - Base class can be imported without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement webhook delivery and retry tests</name>
  <files>upstream/tests_webhooks.py</files>
  <action>
    Add test methods to WebhookTestCase:

    1. test_webhook_delivery_success:
       - Mock HTTP 200 response
       - Create WebhookDelivery, call deliver_webhook()
       - Assert status='success', attempts=1, response_code=200

    2. test_webhook_signature_header:
       - Mock HTTP 200, capture request headers
       - Verify X-Signature header present and valid HMAC-SHA256
       - Use responses.calls[0].request.headers to inspect

    3. test_webhook_retry_on_500:
       - Mock HTTP 500 response
       - Call deliver_webhook(), assert status='retrying', attempts=1
       - Assert next_attempt_at is set (exponential backoff)

    4. test_webhook_max_retries_terminal_failure:
       - Create delivery with max_attempts=3
       - Call deliver_webhook() 3 times with HTTP 500
       - Assert final status='failed' after 3rd attempt

    5. test_webhook_timeout_triggers_retry:
       - Use responses.add() with body=responses.RequestException
       - Assert status='retrying' after timeout

    6. test_webhook_idempotency_key:
       - Deliver same webhook twice with 200 response
       - Verify request_id in payload.metadata is consistent
       - Second delivery should not create duplicate (check payload)

    7. test_webhook_payload_structure:
       - Verify payload contains event_type, data, metadata.request_id
       - Verify Content-Type: application/json header

    8. test_webhook_inactive_endpoint_skips_delivery:
       - Set endpoint.active=False
       - create_webhook_delivery() should return None
  </action>
  <verify>
    ```bash
    python manage.py test upstream.tests_webhooks -v 2
    ```
    All 8 tests pass.
  </verify>
  <done>
    - 8 webhook tests implemented and passing
    - Tests cover: success, signature, retry, max retries, timeout, idempotency, payload structure, inactive endpoint
    - Test suite validates all webhook behaviors
  </done>
</task>

</tasks>

<verification>
```bash
# Run webhook tests
python manage.py test upstream.tests_webhooks -v 2

# Verify test count (should be 8+)
python manage.py test upstream.tests_webhooks --verbosity=0 2>&1 | grep -E "^(OK|Ran)"

# Verify responses library in requirements
grep "responses" requirements.txt
```
</verification>

<success_criteria>
- [ ] WebhookTestCase base class with setUp and helper methods
- [ ] 8+ webhook integration tests pass
- [ ] Tests validate: delivery, signature, retry logic, max retries, timeout, idempotency
- [ ] responses library added to requirements.txt
- [ ] Test suite fails if webhook delivery or retry logic breaks
</success_criteria>

<output>
After completion, create `.planning/phases/04-webhook-and-rbac-testing/04-01-SUMMARY.md`
</output>
