{% extends "upstream/base.html" %}
{% load static %}

{% block title %}Alert Deep Dive - Upstream{% endblock %}

{% block content %}
<div class="container">
    {% if not alert_event %}
    <div class="error-message">
        <h2>Alert Not Found</h2>
        <p>The requested alert could not be found or you do not have access to it.</p>
        <a href="{% url 'driftwatch_dashboard' %}" class="btn-primary">‚Üê Back to DriftWatch</a>
    </div>
    {% else %}

    <div class="page-header">
        <div class="header-row">
            <div>
                <h1>Alert Deep Dive</h1>
                <p class="breadcrumb">
                    <a href="{% url 'axis_hub' %}">Axis</a> ‚Ä∫
                    <a href="{% url 'driftwatch_dashboard' %}">DriftWatch</a> ‚Ä∫
                    Alert #{{ alert_event.id }}
                </p>
            </div>
            <div class="header-actions">
                <a href="{% url 'driftwatch_dashboard' %}" class="btn-secondary">‚Üê Back to Dashboard</a>
            </div>
        </div>
    </div>

    <!-- Alert Status Card -->
    <div class="card">
        <h2>Alert Status</h2>
        <div class="status-grid">
            <div class="status-item">
                <span class="label">Status:</span>
                <span class="badge badge-{{ alert_event.status }}">{{ alert_event.get_status_display }}</span>
            </div>
            <div class="status-item">
                <span class="label">Triggered:</span>
                <span>{{ alert_event.triggered_at|date:"M d, Y H:i" }}</span>
            </div>
            <div class="status-item">
                <span class="label">Rule:</span>
                <span>{{ alert_event.alert_rule.name }}</span>
            </div>
            {% if latest_judgment %}
            <div class="status-item">
                <span class="label">Operator Verdict:</span>
                <span class="badge badge-{{ latest_judgment.verdict }}">{{ latest_judgment.get_verdict_display }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Interpretation Card -->
    {% if interpretation %}
    <div class="card interpretation-card">
        <h2>üéØ What This Means</h2>
        <div class="urgency-banner urgency-{{ interpretation.urgency_level }}">
            <span class="urgency-icon">
                {% if interpretation.urgency_level == 'high' %}üî¥{% elif interpretation.urgency_level == 'medium' %}üü°{% else %}üü¢{% endif %}
            </span>
            <div>
                <strong>{{ interpretation.urgency_label }}</strong>
                <p>{{ interpretation.plain_language }}</p>
            </div>
        </div>

        {% if interpretation.is_likely_noise %}
        <div class="noise-warning">
            ‚ö†Ô∏è This alert may be noise. Review carefully before taking action.
        </div>
        {% endif %}

        <h3>Recommended Actions</h3>
        <ul class="action-steps">
            {% for step in interpretation.action_steps %}
            <li>{{ step }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Evidence Payload -->
    {% if evidence_payload %}
    <div class="card">
        <h2>üìä Evidence Summary</h2>
        <div class="evidence-grid">
            <div class="evidence-item">
                <span class="label">Payer:</span>
                <strong>{{ evidence_payload.entity_label }}</strong>
            </div>
            <div class="evidence-item">
                <span class="label">Signal Type:</span>
                <span>{{ evidence_payload.signal_type }}</span>
            </div>
            <div class="evidence-item">
                <span class="label">Baseline:</span>
                <span>{{ evidence_payload.baseline_value|floatformat:1 }}%</span>
            </div>
            <div class="evidence-item">
                <span class="label">Current:</span>
                <span>{{ evidence_payload.current_value|floatformat:1 }}%</span>
            </div>
            <div class="evidence-item">
                <span class="label">Delta:</span>
                <span class="delta {% if evidence_payload.delta > 0 %}positive{% else %}negative{% endif %}">
                    {{ evidence_payload.delta|floatformat:1|stringformat:"+.1" }}%
                </span>
            </div>
            <div class="evidence-item">
                <span class="label">Confidence:</span>
                <span>{{ evidence_payload.confidence|floatformat:0 }}%</span>
            </div>
        </div>

        <h3>Detailed Evidence</h3>
        {% if evidence_payload.evidence_rows %}
        <table class="evidence-table">
            <thead>
                <tr>
                    <th>Payer</th>
                    <th>CPT Group</th>
                    <th>Type</th>
                    <th>Baseline</th>
                    <th>Current</th>
                    <th>Change</th>
                    <th>Severity</th>
                </tr>
            </thead>
            <tbody>
                {% for row in evidence_payload.evidence_rows %}
                <tr>
                    <td>{{ row.payer }}</td>
                    <td>{{ row.cpt_group }}</td>
                    <td><small>{{ row.drift_type }}</small></td>
                    <td>{{ row.baseline_value|floatformat:1 }}%</td>
                    <td>{{ row.current_value|floatformat:1 }}%</td>
                    <td class="{% if row.delta_value > 0 %}positive{% else %}negative{% endif %}">
                        {{ row.delta_value|floatformat:1|stringformat:"+.1" }}%
                    </td>
                    <td>
                        <div class="severity-bar" style="width: {{ row.severity|floatformat:0 }}%"></div>
                        <small>{{ row.severity|floatformat:0 }}%</small>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="no-data">No detailed evidence available.</p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Sample Claims -->
    {% if sample_claims %}
    <details class="card">
        <summary><h2>üìã Sample Claims ({{ sample_claims|length }})</h2></summary>
        <table class="claims-table">
            <thead>
                <tr>
                    <th>Claim ID</th>
                    <th>Service Date</th>
                    <th>Payer</th>
                    <th>Billed</th>
                    <th>Paid</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for claim in sample_claims %}
                <tr>
                    <td><code>{{ claim.claim_number }}</code></td>
                    <td>{{ claim.service_date|date:"M d, Y" }}</td>
                    <td>{{ claim.payer_name }}</td>
                    <td>${{ claim.billed_amount|floatformat:2 }}</td>
                    <td>${{ claim.paid_amount|floatformat:2 }}</td>
                    <td>{{ claim.claim_status }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </details>
    {% endif %}

    <!-- Operator Judgments History -->
    {% if judgments %}
    <div class="card">
        <h2>üìù Operator Judgment History</h2>
        {% for judgment in judgments %}
        <div class="judgment-entry">
            <div class="judgment-header">
                <span class="badge badge-{{ judgment.verdict }}">{{ judgment.get_verdict_display }}</span>
                <span class="timestamp">{{ judgment.created_at|date:"M d, Y H:i" }} by {{ judgment.operator.username }}</span>
            </div>
            {% if judgment.notes %}
            <p class="judgment-notes">{{ judgment.notes }}</p>
            {% endif %}
            {% if judgment.recovered_amount %}
            <p class="recovery-info">üí∞ Recovered: ${{ judgment.recovered_amount|floatformat:2 }} on {{ judgment.recovered_date|date:"M d, Y" }}</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% endif %}
</div>

<style>
.page-header {
    margin-bottom: 2rem;
}
.header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}
.breadcrumb {
    color: #666;
    font-size: 0.9rem;
}
.breadcrumb a {
    color: #007bff;
    text-decoration: none;
}
.breadcrumb a:hover {
    text-decoration: underline;
}
.header-actions {
    display: flex;
    gap: 0.5rem;
}
.btn-secondary {
    padding: 0.5rem 1rem;
    background: #6c757d;
    color: white;
    text-decoration: none;
    border-radius: 4px;
}
.btn-secondary:hover {
    background: #5a6268;
}
.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}
.status-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}
.status-item .label {
    font-size: 0.85rem;
    color: #666;
}
.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
}
.badge-pending { background: #fff3cd; color: #856404; }
.badge-acknowledged { background: #d1ecf1; color: #0c5460; }
.badge-resolved { background: #d4edda; color: #155724; }
.badge-noise { background: #e0e0e0; color: #616161; }
.badge-real { background: #c8e6c9; color: #2e7d32; }
.badge-needs_followup { background: #fff3e0; color: #e65100; }
.interpretation-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.interpretation-card h2,
.interpretation-card h3 {
    color: white;
}
.urgency-banner {
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    display: flex;
    gap: 1rem;
    align-items: flex-start;
}
.urgency-banner.urgency-high { background: rgba(255, 82, 82, 0.2); border-left: 4px solid #ff5252; }
.urgency-banner.urgency-medium { background: rgba(255, 193, 7, 0.2); border-left: 4px solid #ffc107; }
.urgency-banner.urgency-low { background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4caf50; }
.urgency-icon {
    font-size: 2rem;
}
.noise-warning {
    background: rgba(255, 152, 0, 0.2);
    padding: 0.75rem;
    border-radius: 4px;
    margin: 1rem 0;
    border-left: 4px solid #ff9800;
}
.action-steps {
    list-style: none;
    padding: 0;
}
.action-steps li {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
}
.action-steps li:before {
    content: "‚Üí";
    position: absolute;
    left: 0;
}
.evidence-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}
.evidence-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}
.delta.positive { color: #c62828; }
.delta.negative { color: #2e7d32; }
.evidence-table,
.claims-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}
.evidence-table th,
.evidence-table td,
.claims-table th,
.claims-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}
.evidence-table th,
.claims-table th {
    background: #f5f5f5;
    font-weight: 600;
}
.severity-bar {
    height: 4px;
    background: linear-gradient(90deg, #4caf50 0%, #ffc107 50%, #f44336 100%);
    border-radius: 2px;
    margin-bottom: 2px;
}
.no-data {
    color: #999;
    font-style: italic;
}
details summary {
    cursor: pointer;
    user-select: none;
}
details summary:hover {
    color: #007bff;
}
.judgment-entry {
    padding: 1rem;
    border-left: 3px solid #007bff;
    margin-bottom: 1rem;
    background: #f8f9fa;
}
.judgment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}
.timestamp {
    font-size: 0.85rem;
    color: #666;
}
.judgment-notes {
    margin: 0.5rem 0;
    font-style: italic;
}
.recovery-info {
    margin: 0.5rem 0;
    color: #2e7d32;
    font-weight: 500;
}
.error-message {
    text-align: center;
    padding: 3rem;
}
.btn-primary {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    margin-top: 1rem;
}
.btn-primary:hover {
    background: #0056b3;
}
</style>
{% endblock %}
