{
  "branchName": "milestone-06-hipaa-remediation",
  "context": {
    "phase": "6",
    "phaseName": "HIPAA Technical Safeguards Remediation",
    "phaseGoal": "Address critical HIPAA compliance gaps identified in security audit",
    "dependsOn": [],
    "successCriteria": [
      "MFA implemented for all user authentication",
      "Encryption key rotation policy established",
      "All PHI fields use EncryptedTextField",
      "Redis connections use TLS",
      "Audit log access controls implemented",
      "Automatic session timeout on inactivity"
    ],
    "qualityGates": [
      "python manage.py check",
      "python manage.py test upstream -v 2 --keepdb"
    ]
  },
  "userStories": [
    {
      "id": 1,
      "title": "Implement MFA with django-otp",
      "description": "Add Multi-Factor Authentication using django-otp with TOTP support. Required for HIPAA §164.312(d) Person/Entity Authentication.",
      "acceptanceCriteria": [
        "django-otp and django-otp-totp installed",
        "TOTPDevice model for user MFA enrollment",
        "MFA setup view with QR code generation",
        "MFA verification middleware for protected views",
        "Backup codes for account recovery",
        "MFA can be required per-customer via CustomerAutomationProfile"
      ],
      "files": [
        "upstream/authentication/mfa.py",
        "upstream/authentication/views_mfa.py",
        "upstream/templates/authentication/mfa_setup.html",
        "upstream/templates/authentication/mfa_verify.html"
      ],
      "passes": false
    },
    {
      "id": 2,
      "title": "Establish encryption key rotation policy",
      "description": "Implement key management with rotation for Fernet encryption keys. Required for HIPAA §164.312(a)(2)(iv) Encryption.",
      "acceptanceCriteria": [
        "FIELD_ENCRYPTION_KEY supports key rotation (list of keys)",
        "Primary key for encryption, all keys for decryption",
        "Management command to rotate keys: rotate_encryption_keys",
        "Key rotation re-encrypts data with new primary key",
        "Key age tracking in settings or database",
        "Documentation for key rotation procedure"
      ],
      "files": [
        "upstream/management/commands/rotate_encryption_keys.py",
        "upstream/encryption/key_manager.py",
        "docs/security/key_rotation.md"
      ],
      "passes": false
    },
    {
      "id": 3,
      "title": "Encrypt all PHI fields in models",
      "description": "Apply EncryptedTextField to all fields containing PHI. Required for HIPAA §164.312(a)(2)(iv) Encryption.",
      "acceptanceCriteria": [
        "Audit all models for PHI fields",
        "ClaimRecord: patient_name, patient_dob, diagnosis_codes encrypted",
        "ValidationRule patterns stored encrypted if containing PHI",
        "Migration to convert existing data to encrypted format",
        "Test that encrypted fields are searchable (or document limitation)"
      ],
      "files": [
        "upstream/models.py",
        "upstream/migrations/0027_encrypt_phi_fields.py"
      ],
      "passes": false
    },
    {
      "id": 4,
      "title": "Configure Redis TLS encryption",
      "description": "Enable TLS for Redis connections to protect cached data in transit. Required for HIPAA §164.312(e)(1) Transmission Security.",
      "acceptanceCriteria": [
        "CACHES setting uses rediss:// (TLS) URL scheme",
        "Celery broker uses TLS connection",
        "Redis session store uses TLS",
        "SSL certificate verification enabled",
        "Environment variable REDIS_TLS_URL for configuration",
        "Fallback to non-TLS for local development only"
      ],
      "files": [
        "upstream/settings/base.py",
        "upstream/settings/production.py",
        "docs/deployment/redis_tls.md"
      ],
      "passes": false
    },
    {
      "id": 5,
      "title": "Add audit log access controls",
      "description": "Implement access controls for audit logs with SIEM export capability. Required for HIPAA §164.312(b) Audit Controls.",
      "acceptanceCriteria": [
        "AuditLogAccessPermission restricts log viewing to admins",
        "Log export endpoint with authentication",
        "Syslog forwarding configuration for SIEM",
        "Log integrity verification (checksums or signatures)",
        "Tamper detection for modified log entries",
        "Retention policy enforcement (7 years for HIPAA)"
      ],
      "files": [
        "upstream/audit/permissions.py",
        "upstream/audit/views.py",
        "upstream/audit/siem_export.py",
        "upstream/management/commands/enforce_log_retention.py"
      ],
      "passes": false
    },
    {
      "id": 6,
      "title": "Implement activity-based automatic logoff",
      "description": "Add session timeout after period of inactivity. Required for HIPAA §164.312(a)(2)(iii) Automatic Logoff.",
      "acceptanceCriteria": [
        "Session timeout after 15 minutes of inactivity (configurable)",
        "Frontend activity tracking (mouse, keyboard, scroll)",
        "Warning modal 2 minutes before timeout",
        "Extend session on user activity",
        "JWT token expiry aligned with session timeout",
        "Logout clears all session data"
      ],
      "files": [
        "upstream/authentication/middleware.py",
        "upstream/settings/base.py",
        "frontend/src/hooks/useSessionTimeout.ts",
        "frontend/src/components/SessionTimeoutWarning.tsx"
      ],
      "passes": false
    }
  ]
}
