{
  "branchName": "milestone-04-observability",
  "context": {
    "phase": "4a",
    "phaseName": "Observability and Monitoring",
    "phaseGoal": "Add Prometheus metrics, structured logging, and health checks",
    "dependsOn": [],
    "successCriteria": [
      "Prometheus metrics endpoint exposed",
      "Structured JSON logging configured",
      "Health check endpoints implemented",
      "Key business metrics tracked"
    ],
    "qualityGates": [
      "python manage.py check",
      "curl -s http://localhost:8000/health/ | grep -q 'ok' || true"
    ]
  },
  "userStories": [
    {
      "id": 1,
      "title": "Add Prometheus metrics endpoint",
      "description": "Install django-prometheus and expose /metrics endpoint with default Django metrics.",
      "acceptanceCriteria": [
        "django-prometheus in requirements.txt",
        "Middleware configured for request metrics",
        "/metrics endpoint exposed",
        "Request duration histogram",
        "Request count by path and method",
        "Database query metrics"
      ],
      "files": [
        "requirements.txt",
        "upstream/settings/base.py",
        "upstream/urls.py"
      ],
      "passes": false
    },
    {
      "id": 2,
      "title": "Add custom business metrics",
      "description": "Create custom Prometheus metrics for business-critical operations.",
      "acceptanceCriteria": [
        "upstream/metrics.py with custom metrics",
        "claims_processed_total counter",
        "scoring_duration_seconds histogram",
        "active_customers gauge",
        "alert_triggers_total counter by severity",
        "Metrics updated in relevant views/tasks"
      ],
      "files": [
        "upstream/metrics.py",
        "upstream/views.py"
      ],
      "passes": false
    },
    {
      "id": 3,
      "title": "Configure structured JSON logging",
      "description": "Set up python-json-logger for structured log output suitable for log aggregation.",
      "acceptanceCriteria": [
        "python-json-logger in requirements.txt",
        "JSON formatter configured in LOGGING",
        "Request ID in all log entries",
        "User ID in authenticated request logs",
        "Exception stack traces in JSON format",
        "Log level configurable via environment"
      ],
      "files": [
        "requirements.txt",
        "upstream/settings/base.py",
        "upstream/middleware/logging.py"
      ],
      "passes": false
    },
    {
      "id": 4,
      "title": "Implement health check endpoints",
      "description": "Create health check endpoints for load balancer and Kubernetes probes.",
      "acceptanceCriteria": [
        "GET /health/ - basic liveness check",
        "GET /health/ready/ - readiness with DB check",
        "GET /health/live/ - liveness (always 200)",
        "Database connectivity check",
        "Redis connectivity check",
        "Returns JSON with component status"
      ],
      "files": [
        "upstream/health/views.py",
        "upstream/health/__init__.py",
        "upstream/urls.py"
      ],
      "passes": false
    },
    {
      "id": 5,
      "title": "Add request tracing middleware",
      "description": "Middleware to generate and propagate request IDs for distributed tracing.",
      "acceptanceCriteria": [
        "X-Request-ID header generated if missing",
        "Request ID propagated to all logs",
        "Request ID in response headers",
        "Request ID available via get_current_request_id()",
        "Celery tasks include parent request ID"
      ],
      "files": [
        "upstream/middleware/tracing.py",
        "upstream/settings/base.py"
      ],
      "passes": false
    }
  ]
}
