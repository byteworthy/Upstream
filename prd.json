{
  "branchName": "milestone-05-stripe",
  "context": {
    "phase": "5d",
    "phaseName": "Stripe Payment Integration",
    "phaseGoal": "Integrate Stripe for subscription billing with three pricing tiers",
    "dependsOn": [],
    "criticalPatterns": [
      "ALWAYS use idempotency keys on payment operations",
      "ALWAYS verify webhook signatures before processing",
      "Use webhook-first architecture - never trust API responses for payment status",
      "Handle ALL subscription lifecycle webhooks to prevent state drift",
      "Separate test/live mode configurations completely"
    ],
    "successCriteria": [
      "Stripe SDK installed and configured",
      "Three subscription products created",
      "Checkout flow with idempotency",
      "Webhook handler with signature verification",
      "Customer portal integration",
      "Dunning management for failed payments"
    ],
    "qualityGates": [
      "python manage.py check",
      "python -c \"import stripe; print('Stripe SDK OK')\"",
      "python manage.py test upstream.payments -v 2"
    ]
  },
  "userStories": [
    {
      "id": 1,
      "title": "Install and configure Stripe SDK with idempotency",
      "description": "Install stripe Python package, configure API keys, create service wrapper with idempotency key generation.",
      "acceptanceCriteria": [
        "stripe package in requirements.txt",
        "STRIPE_SECRET_KEY and STRIPE_PUBLISHABLE_KEY env vars",
        "STRIPE_WEBHOOK_SECRET env var for signature verification",
        "upstream/payments/__init__.py created",
        "upstream/payments/stripe_client.py with configured client",
        "generate_idempotency_key() helper function",
        "Test mode detection (STRIPE_TEST_MODE env var)",
        "Separate test/live API key handling"
      ],
      "files": [
        "requirements.txt",
        "upstream/payments/__init__.py",
        "upstream/payments/stripe_client.py",
        "upstream/payments/idempotency.py"
      ],
      "passes": false
    },
    {
      "id": 2,
      "title": "Create subscription products and prices",
      "description": "Define three pricing tiers (Starter $299, Professional $599, Enterprise $999) as Stripe Products with monthly prices.",
      "acceptanceCriteria": [
        "Management command to sync products: sync_stripe_products",
        "Three products with metadata (features list)",
        "Monthly recurring prices",
        "Price IDs stored in settings",
        "Idempotent sync using product metadata lookup",
        "Test mode products separate from live"
      ],
      "files": [
        "upstream/payments/products.py",
        "upstream/management/commands/sync_stripe_products.py"
      ],
      "passes": false
    },
    {
      "id": 3,
      "title": "Implement checkout session with metadata",
      "description": "Create API endpoint to generate Stripe Checkout sessions with proper metadata for webhook processing.",
      "acceptanceCriteria": [
        "POST /api/v1/billing/checkout/ endpoint",
        "Accepts price_id and creates checkout session",
        "MUST include metadata: user_id, customer_id, price_tier",
        "Idempotency key on checkout.Session.create()",
        "Returns checkout URL for redirect",
        "Links checkout to authenticated user",
        "Success and cancel URL configuration",
        "client_reference_id set to internal customer ID"
      ],
      "files": [
        "upstream/payments/views.py",
        "upstream/payments/serializers.py",
        "upstream/urls.py"
      ],
      "passes": false
    },
    {
      "id": 4,
      "title": "Create webhook handler with signature verification",
      "description": "Handle Stripe webhook events with MANDATORY signature verification. Use webhook-first architecture.",
      "acceptanceCriteria": [
        "POST /api/v1/billing/webhook/ endpoint",
        "CRITICAL: Signature verification with stripe.Webhook.construct_event()",
        "Raw request body preserved (no JSON parsing before verify)",
        "Handle checkout.session.completed - activate subscription",
        "Handle customer.subscription.created",
        "Handle customer.subscription.updated - sync status",
        "Handle customer.subscription.deleted - deactivate",
        "Handle invoice.paid - record payment",
        "Handle invoice.payment_failed - trigger dunning",
        "Idempotent event processing (store processed event IDs)",
        "Update Customer model subscription_status field",
        "Webhook endpoint excluded from CSRF protection"
      ],
      "files": [
        "upstream/payments/webhooks.py",
        "upstream/payments/models.py",
        "upstream/models.py"
      ],
      "passes": false
    },
    {
      "id": 5,
      "title": "Add customer billing portal",
      "description": "Create endpoint to generate Stripe Customer Portal sessions for self-service billing management.",
      "acceptanceCriteria": [
        "POST /api/v1/billing/portal/ endpoint",
        "Returns portal URL for redirect",
        "Customer can update payment method",
        "Customer can view invoices",
        "Customer can cancel subscription",
        "Return URL configured",
        "Portal configuration in Stripe Dashboard documented"
      ],
      "files": [
        "upstream/payments/views.py"
      ],
      "passes": false
    },
    {
      "id": 6,
      "title": "Implement dunning management for failed payments",
      "description": "Handle failed payment retries and customer communication for subscription recovery.",
      "acceptanceCriteria": [
        "Handle invoice.payment_failed webhook",
        "Track payment failure count on Customer",
        "Send email notification on first failure",
        "Grace period before subscription suspension (7 days)",
        "Handle invoice.payment_action_required for 3DS",
        "Automatic retry configuration in Stripe settings",
        "Log all dunning events for audit",
        "Admin visibility into at-risk subscriptions"
      ],
      "files": [
        "upstream/payments/dunning.py",
        "upstream/payments/emails.py",
        "upstream/models.py"
      ],
      "passes": false
    },
    {
      "id": 7,
      "title": "Add Stripe integration tests",
      "description": "Comprehensive tests using Stripe test mode and mock webhooks.",
      "acceptanceCriteria": [
        "Test checkout session creation",
        "Test webhook signature verification (valid and invalid)",
        "Test subscription lifecycle via webhooks",
        "Test idempotency key deduplication",
        "Test dunning flow with failed payment webhook",
        "Use Stripe test card numbers",
        "Mock webhook events for CI"
      ],
      "files": [
        "upstream/payments/tests.py",
        "upstream/payments/test_webhooks.py"
      ],
      "passes": false
    }
  ]
}
