name: Upstream Agents - Quality & Compliance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Manual trigger

jobs:
  code-quality:
    name: Code Quality Auditor
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up environment
      run: |
        cp .env.example .env
        echo "SECRET_KEY=ci-test-secret-key-$(openssl rand -hex 32)" >> .env
        echo "DEBUG=True" >> .env

    - name: Run migrations
      run: |
        python manage.py migrate --noinput

    - name: Run Code Quality Auditor
      run: |
        python manage.py audit_code_quality --fail-on critical --report reports/code-quality.json
      continue-on-error: false

    - name: Upload Code Quality Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-report
        path: reports/code-quality.json

  database-performance:
    name: Database Performance Optimizer
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up environment
      run: |
        cp .env.example .env
        echo "SECRET_KEY=ci-test-secret-key-$(openssl rand -hex 32)" >> .env
        echo "DEBUG=True" >> .env

    - name: Run migrations
      run: |
        python manage.py migrate --noinput

    - name: Run Database Performance Optimizer
      run: |
        python manage.py optimize_database --app upstream
      continue-on-error: true  # Informational only

    - name: Upload Performance Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: database-performance-report
        path: reports/

  test-coverage:
    name: Test Coverage Analyzer
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up environment
      run: |
        cp .env.example .env
        echo "SECRET_KEY=ci-test-secret-key-$(openssl rand -hex 32)" >> .env
        echo "DEBUG=True" >> .env

    - name: Run migrations
      run: |
        python manage.py migrate --noinput

    - name: Run Test Coverage Analyzer
      run: |
        python manage.py analyze_test_coverage --min-coverage 70 --html
      continue-on-error: true  # Warn only

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: htmlcov/

  migration-safety:
    name: Migration Safety Checker
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up environment
      run: |
        cp .env.example .env
        echo "SECRET_KEY=ci-test-secret-key-$(openssl rand -hex 32)" >> .env
        echo "DEBUG=True" >> .env

    - name: Run Migration Safety Checker
      run: |
        python manage.py check_migrations --rollback-plan
      continue-on-error: false  # Block on high-risk migrations

  hipaa-compliance:
    name: HIPAA Compliance Monitor
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up environment
      run: |
        cp .env.example .env
        echo "SECRET_KEY=ci-test-secret-key-$(openssl rand -hex 32)" >> .env
        echo "DEBUG=True" >> .env

    - name: Run migrations
      run: |
        python manage.py migrate --noinput

    - name: Run HIPAA Compliance Monitor
      run: |
        python manage.py check_hipaa_compliance --fail-on critical --report reports/hipaa-compliance.json
      continue-on-error: false  # Block on violations

    - name: Upload HIPAA Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: hipaa-compliance-report
        path: reports/hipaa-compliance.json

  summary:
    name: Agent Summary
    runs-on: ubuntu-latest
    needs: [code-quality, database-performance, test-coverage, migration-safety, hipaa-compliance]
    if: always()

    steps:
    - name: Download all reports
      uses: actions/download-artifact@v4
      with:
        path: all-reports/

    - name: Display Summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ¤– Upstream Agents - Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Code Quality: ${{ needs.code-quality.result }}"
        echo "âœ… Database Performance: ${{ needs.database-performance.result }}"
        echo "âœ… Test Coverage: ${{ needs.test-coverage.result }}"
        echo "âœ… Migration Safety: ${{ needs.migration-safety.result }}"
        echo "âœ… HIPAA Compliance: ${{ needs.hipaa-compliance.result }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # Check if any critical jobs failed
        if [ "${{ needs.code-quality.result }}" != "success" ] || \
           [ "${{ needs.migration-safety.result }}" != "success" ] || \
           [ "${{ needs.hipaa-compliance.result }}" != "success" ]; then
          echo "âŒ CRITICAL AGENTS FAILED - Review reports"
          exit 1
        fi

        echo "âœ… All critical checks passed"
