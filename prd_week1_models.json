{
  "branchName": "ralph/week1-models-foundation",
  "context": {
    "phase": "Week 1 - Models Layer",
    "phaseName": "Database Models for Autonomous Execution",
    "phaseGoal": "Create AutomationRule, ExecutionLog, Authorization models + enhance ClaimRecord",
    "requirements": [
      "Stories 2-5: Sequential model additions to upstream/models.py"
    ],
    "dependsOn": "RiskBaseline model (Task 1 - complete)",
    "successCriteria": [
      "All 4 models added to upstream/models.py",
      "All migrations applied successfully",
      "Tests pass"
    ],
    "qualityGates": [
      "python manage.py check --settings=upstream.settings.test",
      "python manage.py test upstream --settings=upstream.settings.test -v 2"
    ]
  },
  "userStories": [
    {
      "id": 2,
      "title": "Create AutomationRule model for execution layer",
      "description": "Add AutomationRule model to upstream/models.py for pre-approved workflow rules. Fields: customer (FK), rule_type (choices: 'reauth', 'appeal', 'high_risk_hold'), trigger_conditions (JSONField with payer, cpt_code, denial_rate_threshold), actions (JSONField with action_type, payer_portal_steps), is_active (bool), created_at, last_executed. Add CustomerScopedManager for tenant isolation. Include indexes for (customer, rule_type, is_active). Add CHECK constraints for valid rule_type choices.",
      "acceptanceCriteria": [
        "AutomationRule model added to upstream/models.py",
        "JSONField for trigger_conditions with schema validation",
        "JSONField for actions with schema validation",
        "rule_type choices: 'reauth', 'appeal', 'high_risk_hold'",
        "CustomerScopedManager for tenant isolation",
        "Composite index on (customer, rule_type, is_active)",
        "CHECK constraint for rule_type validation",
        "Migration created and applied",
        "Tests pass"
      ],
      "files": [
        "upstream/models.py",
        "upstream/migrations/0022_add_automation_rule.py"
      ],
      "passes": false
    },
    {
      "id": 3,
      "title": "Create ExecutionLog model for audit trail",
      "description": "Add ExecutionLog model to upstream/models.py for complete HIPAA audit trail. Fields: customer (FK), rule (FK to AutomationRule, nullable), action_type (CharField), target_claim (FK to ClaimRecord, nullable), input_data (JSONField), output_data (JSONField), status (choices: 'success', 'failed', 'pending'), error_message (TextField, nullable), executed_by (FK to User, nullable for system), executed_at (DateTimeField, auto_now_add). Add CustomerScopedManager. Include indexes for (customer, executed_at) and (target_claim, status). Add CHECK constraint for status validation.",
      "acceptanceCriteria": [
        "ExecutionLog model added to upstream/models.py",
        "Complete audit trail with input/output JSONFields",
        "status choices: 'success', 'failed', 'pending'",
        "Nullable rule FK for ad-hoc actions",
        "Nullable executed_by for system vs human actions",
        "CustomerScopedManager for tenant isolation",
        "Indexes on (customer, executed_at) and (target_claim, status)",
        "CHECK constraint for status validation",
        "Migration created and applied",
        "Tests pass"
      ],
      "files": [
        "upstream/models.py",
        "upstream/migrations/0023_add_execution_log.py"
      ],
      "passes": false
    },
    {
      "id": 4,
      "title": "Create Authorization model for calendar-based alerts",
      "description": "Add Authorization model to upstream/models.py for tracking authorization expirations (ABA focus). Fields: customer (FK), patient_identifier (CharField, encrypted), payer (CharField), authorization_number (CharField), service_type (CharField), start_date (DateField), end_date (DateField, indexed), units_authorized (IntegerField), units_used (IntegerField, default=0), status (choices: 'active', 'expiring_soon', 'expired', 'renewed'), last_checked (DateTimeField), related_claims (ManyToMany to ClaimRecord). Add CustomerScopedManager. Include partial index on (customer, end_date) WHERE status='active'. Add CHECK constraint for units_used <= units_authorized.",
      "acceptanceCriteria": [
        "Authorization model added to upstream/models.py",
        "patient_identifier uses EncryptedCharField for PHI",
        "status choices: 'active', 'expiring_soon', 'expired', 'renewed'",
        "Partial index on (customer, end_date) for active auths only",
        "ManyToMany relationship with ClaimRecord",
        "CHECK constraint: units_used <= units_authorized",
        "CHECK constraint: end_date >= start_date",
        "CustomerScopedManager for tenant isolation",
        "Migration created and applied",
        "Tests pass"
      ],
      "files": [
        "upstream/models.py",
        "upstream/migrations/0024_add_authorization.py"
      ],
      "passes": false
    },
    {
      "id": 5,
      "title": "Enhance ClaimRecord for multi-source ingestion",
      "description": "Add submitted_via field to ClaimRecord model in upstream/models.py to track claim source. Field: submitted_via (CharField with choices: 'csv_upload', 'ehr_webhook', 'payer_portal_scrape', 'manual_entry', default='csv_upload'). Add index on submitted_via for filtering. Add migration to add field with default value for existing records. Update ClaimRecord __str__ method to include source. No breaking changes to existing functionality.",
      "acceptanceCriteria": [
        "submitted_via field added with choices",
        "Default value 'csv_upload' for backward compatibility",
        "Index on submitted_via for filtering",
        "Migration handles existing records (default='csv_upload')",
        "ClaimRecord __str__ updated to show source",
        "No breaking changes to existing tests",
        "Tests pass"
      ],
      "files": [
        "upstream/models.py",
        "upstream/migrations/0025_add_claim_source.py"
      ],
      "passes": false
    }
  ]
}
