{% extends "payrixa/base.html" %}

{% block title %}Uploads{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Uploads</h2>
    <p>Manage your data uploads</p>
</div>

<div class="phi-warning-banner" style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
    <strong>⚠️ Privacy Protection:</strong> NEVER include patient names, dates of birth, SSN, or addresses in your uploads.
    Use payer organization names only (e.g., "Blue Cross Blue Shield", "Medicare", "Aetna").
    Uploads containing patient-like names will be rejected.
</div>

<div class="uploads-container">
    <div class="upload-card">
        <h3>Upload New File</h3>
        <p>Upload your claims data in CSV format</p>
        <form method="post" enctype="multipart/form-data" class="upload-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="csv_file">CSV File</label>
                <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload File</button>
        </form>
    </div>

    <div class="recent-uploads">
        <h3>Recent Uploads</h3>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Status</th>
                        <th>Uploaded</th>
                        <th>Rows</th>
                        <th>Quality</th>
                        <th>Date Range</th>
                    </tr>
                </thead>
                <tbody>
                    {% if uploads %}
                        {% for upload in uploads %}
                        <tr>
                            <td>{{ upload.filename }}</td>
                            <td>
                                <span class="status-badge status-{{ upload.status }}">
                                    {{ upload.get_status_display }}
                                </span>
                                {% if upload.error_message %}
                                    <div class="error-tooltip">{{ upload.error_message }}</div>
                                {% endif %}
                            </td>
                            <td>{{ upload.uploaded_at|date:"Y-m-d H:i" }}</td>
                            <td>{{ upload.row_count|default:"-" }}</td>
                            <td>
                                {% if upload.quality_report %}
                                    {% with qr=upload.quality_report %}
                                        {% if qr.quality_score >= 0.95 %}
                                            <span class="quality-badge quality-excellent" title="{{ qr.accepted_rows }}/{{ qr.total_rows }} accepted">
                                                ✓ {{ qr.quality_score|floatformat:0|add:"0" }}%
                                            </span>
                                        {% elif qr.quality_score >= 0.80 %}
                                            <span class="quality-badge quality-good" title="{{ qr.accepted_rows }}/{{ qr.total_rows }} accepted">
                                                ⚠ {{ qr.quality_score|floatformat:0|add:"0" }}%
                                            </span>
                                        {% else %}
                                            <span class="quality-badge quality-poor" title="{{ qr.accepted_rows }}/{{ qr.total_rows }} accepted">
                                                ✗ {{ qr.quality_score|floatformat:0|add:"0" }}%
                                            </span>
                                        {% endif %}
                                        {% if qr.has_issues %}
                                            <a href="#quality-{{ upload.id }}" class="quality-details-link" onclick="document.getElementById('quality-{{ upload.id }}').style.display='block'; return false;">
                                                Details
                                            </a>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if upload.date_min and upload.date_max %}
                                    {{ upload.date_min|date:"Y-m-d" }} to {{ upload.date_max|date:"Y-m-d" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% if upload.quality_report and upload.quality_report.has_issues %}
                        <tr id="quality-{{ upload.id }}" class="quality-details-row" style="display: none;">
                            <td colspan="6">
                                {% with qr=upload.quality_report %}
                                <div class="quality-report-panel">
                                    <h4>Data Quality Report</h4>
                                    <div class="quality-summary">
                                        <div class="quality-stat">
                                            <span class="label">Total Rows:</span>
                                            <span class="value">{{ qr.total_rows }}</span>
                                        </div>
                                        <div class="quality-stat">
                                            <span class="label">Accepted:</span>
                                            <span class="value accepted">{{ qr.accepted_rows }}</span>
                                        </div>
                                        <div class="quality-stat">
                                            <span class="label">Rejected:</span>
                                            <span class="value rejected">{{ qr.rejected_rows }}</span>
                                        </div>
                                    </div>

                                    {% if qr.rejected_rows > 0 %}
                                    <div class="rejection-summary">
                                        <h5>Rejection Reasons:</h5>
                                        <ul>
                                            {% if qr.phi_detections > 0 %}
                                            <li><strong>PHI detected:</strong> {{ qr.phi_detections }} rows (patient-like names)</li>
                                            {% endif %}
                                            {% if qr.missing_fields > 0 %}
                                            <li><strong>Missing fields:</strong> {{ qr.missing_fields }} rows</li>
                                            {% endif %}
                                            {% if qr.invalid_dates > 0 %}
                                            <li><strong>Invalid dates:</strong> {{ qr.invalid_dates }} rows</li>
                                            {% endif %}
                                            {% if qr.invalid_values > 0 %}
                                            <li><strong>Invalid values:</strong> {{ qr.invalid_values }} rows</li>
                                            {% endif %}
                                        </ul>

                                        <details class="rejection-details-expand">
                                            <summary>Show rejected row details ({{ qr.rejected_rows }} rows)</summary>
                                            <div class="rejected-rows-list">
                                                {% for row_num, reason in qr.rejection_details.items %}
                                                <div class="rejected-row">
                                                    <span class="row-num">Row {{ row_num }}:</span>
                                                    <span class="reason">{{ reason }}</span>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </details>
                                    </div>
                                    {% endif %}

                                    {% if qr.warnings %}
                                    <div class="warnings-section">
                                        <h5>Warnings:</h5>
                                        <ul>
                                            {% for warning in qr.warnings %}
                                            <li>Row {{ warning.row }}: {{ warning.message }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}

                                    <button onclick="document.getElementById('quality-{{ upload.id }}').style.display='none';" class="btn btn-secondary btn-sm">
                                        Close
                                    </button>
                                </div>
                                {% endwith %}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="empty-state">No uploads yet</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
