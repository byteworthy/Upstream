{% extends "payrixa/base.html" %}
{% load static %}

{% block title %}DelayGuard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>‚è∞ DelayGuard</h1>
        <p class="subtitle">Payment delay drift detection. <strong>V1 Signal:</strong> PAYMENT_DELAY_DRIFT</p>
    </div>

    <!-- What is This? Section -->
    <div class="info-section">
        <details>
            <summary><h3 style="margin: 0;">‚è±Ô∏è What is DelayGuard?</h3></summary>
            <div class="collapsible-content">
                <p><strong>DelayGuard detects when payers start taking longer to process your claims than normal.</strong></p>
                <p>We compare recent payment times (last 14 days) to your baseline (prior 60 days). If it's slower, we flag it.</p>

                <div class="info-grid">
                    <div class="info-card">
                        <h4>What "Days-to-Payment" means</h4>
                        <p>The time between when you submit a claim and when the payer decides to pay it. If they normally take 25 days and suddenly take 35 days, that's a +10 day delay worth investigating.</p>
                    </div>
                    <div class="info-card">
                        <h4>What "Baseline" means</h4>
                        <p><strong>Baseline</strong> = Average payment time over prior 60 days.<br>
                        <strong>Current</strong> = Average over recent 14 days.<br>
                        <strong>Delta</strong> = The difference (+ means slower, - means faster).</p>
                    </div>
                    <div class="info-card">
                        <h4>What "Severity" means</h4>
                        <p><strong>Critical</strong>: +10 days or more - investigate today<br>
                        <strong>High</strong>: +7-10 days - review this week<br>
                        <strong>Medium</strong>: +4-7 days - monitor<br>
                        <strong>Low</strong>: +2-4 days - note for later</p>
                    </div>
                    <div class="info-card">
                        <h4>When to care</h4>
                        <p><strong>Investigate today</strong>: Critical severity or +15 days<br>
                        <strong>Check this week</strong>: High severity or +10 days<br>
                        <strong>Monitor</strong>: Medium severity or +5 days<br>
                        <strong>Note for later</strong>: Low severity or +2-3 days</p>
                    </div>
                </div>
            </div>
        </details>
    </div>

    {% if error %}
    <div class="alert-error">{{ error }}</div>
    {% else %}

    <!-- Summary Cards -->
    <div class="cards">
        <div class="card">
            <h3>Active Delay Signals</h3>
            <p class="card-value">{{ total_signals }}</p>
            <p class="card-sub">{{ critical_count }} critical, {{ high_count }} high</p>
        </div>

        <div class="card">
            <h3>Avg Payment Delay Increase</h3>
            <p class="card-value">+{{ avg_delta|floatformat:1 }} days</p>
            <p class="card-sub">Across all payers</p>
        </div>

        <div class="card">
            <h3>Est. Cash at Risk</h3>
            <p class="card-value">${{ total_at_risk|floatformat:0|default:"0" }}</p>
            <p class="card-sub">Delayed payment impact</p>
        </div>

        <!-- Recovery Ledger Card -->
        <div class="card recovery-card">
            <h3>üí∞ Recovered This Month</h3>
            <p class="card-value recovery-amount">${{ recovery_stats.this_month_total|floatformat:2 }}</p>
            <p class="card-sub">{{ recovery_stats.this_month_count }} alert{{ recovery_stats.this_month_count|pluralize }} resolved</p>
            <details class="recovery-details">
                <summary>View breakdown</summary>
                <div class="recovery-breakdown">
                    <div class="recovery-stat">
                        <span class="label">Last 30 days:</span>
                        <span class="value">${{ recovery_stats.last_30_days_total|floatformat:2 }}</span>
                    </div>
                    <div class="recovery-stat">
                        <span class="label">All time:</span>
                        <span class="value">${{ recovery_stats.all_time_total|floatformat:2 }}</span>
                    </div>
                    {% if recovery_stats.recent_recoveries %}
                    <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Recent Recoveries</h4>
                    <ul class="recent-recoveries-list">
                        {% for recovery in recovery_stats.recent_recoveries %}
                        <li>
                            <strong>${{ recovery.recovered_amount|floatformat:2 }}</strong>
                            - {{ recovery.operator.username }}
                            <small>({{ recovery.recovered_date|date:"M d" }})</small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </details>
        </div>
    </div>

    <!-- Top Payers by Delay -->
    <div class="section">
        <details open>
            <summary><h3 style="margin: 0;">Top Payers by Delay Frequency</h3></summary>
            <div class="collapsible-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Payer</th>
                            <th>Signal Count</th>
                            <th>Avg Delay Increase</th>
                            <th>Max Delay</th>
                            <th>Est. Cash at Risk</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payer in top_payers %}
                        <tr>
                            <td>{{ payer.payer }}</td>
                            <td>{{ payer.signal_count }}</td>
                            <td>+{{ payer.avg_delta|floatformat:1 }} days</td>
                            <td>+{{ payer.max_delta|floatformat:1 }} days</td>
                            <td>${{ payer.total_at_risk|floatformat:0 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="empty">No delay signals yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    </div>

    <!-- Recent Delay Signals -->
    <div class="section">
        <details open>
            <summary><h3 style="margin: 0;">Recent Payment Delay Signals</h3></summary>
            <div class="collapsible-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Action</th>
                            <th>Payer</th>
                            <th>Baseline</th>
                            <th>Current</th>
                            <th>Delta</th>
                            <th>Severity</th>
                            <th>Confidence</th>
                            <th>Est. at Risk</th>
                            <th>Detected</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in signals %}
                        <tr class="{% if item.urgency_level >= 4 %}high-urgency{% elif item.urgency_level >= 3 %}medium-urgency{% else %}low-urgency{% endif %}">
                            <td>
                                {% if item.alert_event_id %}
                                <div class="action-buttons">
                                    {% if item.has_judgment %}
                                        <!-- Show judgment status -->
                                        {% if item.judgment_verdict == 'real' %}
                                        <span class="judgment-badge judgment-real" title="Marked as Real">‚úì Real</span>
                                        {% elif item.judgment_verdict == 'noise' %}
                                        <span class="judgment-badge judgment-noise" title="Marked as Noise">üîá Noise</span>
                                        {% elif item.judgment_verdict == 'needs_followup' %}
                                        <span class="judgment-badge judgment-followup" title="Needs Follow-up">‚ö† Follow-up</span>
                                        {% endif %}
                                    {% else %}
                                        <!-- Show action buttons -->
                                        <button class="btn-mini btn-reviewed"
                                                onclick="markAlert({{ item.alert_event_id }}, 'real')">‚úì</button>
                                        <a href="{% url 'alert_deep_dive' item.alert_event_id %}"
                                           class="btn-mini btn-deep-dive">üîç</a>
                                        <button class="btn-mini btn-noise"
                                                onclick="markAlert({{ item.alert_event_id }}, 'noise')">üîá</button>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="text-muted">No alert</span>
                                {% endif %}

                                <!-- Suppression context badge (Phase 1b) -->
                                {% if item.suppression_context %}
                                <div class="suppression-badge suppression-{{ item.suppression_context.type }}"
                                     title="{{ item.suppression_context.message }}">
                                    {% if item.suppression_context.type == 'noise' %}
                                    üîá Similar marked noise
                                    {% elif item.suppression_context.type == 'confirmed' %}
                                    ‚úì Similar confirmed real
                                    {% elif item.suppression_context.type == 'pending' %}
                                    ‚ö† Similar pending follow-up
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                            <td><strong>{{ item.payer }}</strong></td>
                            <td>{{ item.baseline_avg_days|floatformat:1 }} days</td>
                            <td>{{ item.current_avg_days|floatformat:1 }} days</td>
                            <td class="{% if item.delta_days >= 10 %}high-delta{% elif item.delta_days >= 5 %}medium-delta{% endif %}">
                                +{{ item.delta_days|floatformat:1 }} days<br>
                                <small>(+{{ item.delta_percent|floatformat:1 }}%)</small>
                            </td>
                            <td>
                                <span class="badge severity-{{ item.severity }}">{{ item.severity|upper }}</span>
                                <br><small>{{ item.urgency_label }}</small>
                            </td>
                            <td>{{ item.confidence|floatformat:2 }}</td>
                            <td>${{ item.estimated_dollars_at_risk|floatformat:0 }}</td>
                            <td>{{ item.created_at|date:"M d, Y" }}<br><small>{{ item.created_at|date:"g:i A" }}</small></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="empty">No recent payment delay signals.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    </div>

    {% endif %}
</div>

<!-- Action feedback JavaScript -->
<script>
function markAlert(alertId, verdict) {
    if (!confirm(`Mark this alert as ${verdict}?`)) {
        return;
    }

    fetch(`/api/v1/alerts/${alertId}/feedback/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            verdict: verdict,
            reason_codes: []
        })
    })
    .then(response => {
        if (response.ok) {
            alert(`Alert marked as ${verdict}. Reloading...`);
            location.reload();
        } else {
            return response.json().then(data => {
                alert(`Error: ${data.error || 'Failed to mark alert'}`);
            });
        }
    })
    .catch(error => {
        alert(`Error: ${error.message}`);
    });
}
</script>

<style>
/* DelayGuard specific styles */
.high-delta {
    color: #d32f2f;
    font-weight: bold;
}

.medium-delta {
    color: #f57c00;
    font-weight: bold;
}

.recovery-card {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border-left: 4px solid #4caf50;
}

.recovery-amount {
    color: #2e7d32;
    font-size: 2rem;
    font-weight: bold;
}

.recovery-details summary {
    cursor: pointer;
    font-size: 0.875rem;
    color: #1976d2;
    margin-top: 0.5rem;
}

.recovery-breakdown {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #a5d6a7;
}

.recovery-stat {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
}

.recovery-stat .label {
    color: #666;
}

.recovery-stat .value {
    font-weight: bold;
    color: #2e7d32;
}

.recent-recoveries-list {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0 0;
}

.recent-recoveries-list li {
    padding: 0.5rem;
    border-bottom: 1px solid #e0e0e0;
}

.recent-recoveries-list li:last-child {
    border-bottom: none;
}

.action-buttons {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
}

.btn-mini {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
    border-radius: 3px;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s ease;
}

.btn-mini:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-reviewed {
    border-color: #4caf50;
    color: #4caf50;
}

.btn-reviewed:hover {
    background: #4caf50;
    color: white;
}

.btn-deep-dive {
    border-color: #2196f3;
    color: #2196f3;
}

.btn-deep-dive:hover {
    background: #2196f3;
    color: white;
}

.btn-noise {
    border-color: #ff9800;
    color: #ff9800;
}

.btn-noise:hover {
    background: #ff9800;
    color: white;
}

.judgment-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 3px;
    font-weight: bold;
}

.judgment-real {
    background: #c8e6c9;
    color: #2e7d32;
    border: 1px solid #81c784;
}

.judgment-noise {
    background: #ffe0b2;
    color: #e65100;
    border: 1px solid #ffb74d;
}

.judgment-followup {
    background: #fff9c4;
    color: #f57f17;
    border: 1px solid #fff176;
}

.suppression-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    border-radius: 3px;
    margin-top: 0.25rem;
    opacity: 0.9;
}

.suppression-noise {
    background: #ffecb3;
    color: #f57c00;
    border: 1px solid #ffd54f;
}

.suppression-confirmed {
    background: #c8e6c9;
    color: #388e3c;
    border: 1px solid #81c784;
}

.suppression-pending {
    background: #fff9c4;
    color: #fbc02d;
    border: 1px solid #fff176;
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: bold;
    text-transform: uppercase;
}

.severity-critical {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ef5350;
}

.severity-high {
    background: #fff3e0;
    color: #e65100;
    border: 1px solid #ff9800;
}

.severity-medium {
    background: #fff9c4;
    color: #f57f17;
    border: 1px solid #fdd835;
}

.severity-low {
    background: #e3f2fd;
    color: #1565c0;
    border: 1px solid #64b5f6;
}

.high-urgency {
    background-color: #ffebee;
}

.medium-urgency {
    background-color: #fff3e0;
}

.low-urgency {
    background-color: #ffffff;
}

.text-muted {
    color: #999;
    font-size: 0.875rem;
}
</style>
{% endblock %}
